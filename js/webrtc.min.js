!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leancloud-realtime")):"function"==typeof define&&define.amd?define("webrtc",["exports","leancloud-realtime"],t):t((e=e||self).AV=e.AV||{},e.AV)}(this,function(e,t){"use strict";function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function c(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,t){return e(t={exports:{}},t.exports),t.exports}var o=r(function(e){var r=Object.prototype.hasOwnProperty,p="~";function n(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,n,r,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new s(n,r||e,o),a=p?p+t:t;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],i]:e._events[a].push(i):(e._events[a]=i,e._eventsCount++),e}function u(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function t(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(p=!1)),t.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)r.call(e,t)&&n.push(p?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},t.prototype.listeners=function(e){var t=p?p+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,o=n.length,i=new Array(o);r<o;r++)i[r]=n[r].fn;return i},t.prototype.listenerCount=function(e){var t=p?p+e:e,n=this._events[t];return n?n.fn?1:n.length:0},t.prototype.emit=function(e,t,n,r,o,i){var a=p?p+e:e;if(!this._events[a])return!1;var s,c,u=this._events[a],l=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,r),!0;case 5:return u.fn.call(u.context,t,n,r,o),!0;case 6:return u.fn.call(u.context,t,n,r,o,i),!0}for(c=1,s=new Array(l-1);c<l;c++)s[c-1]=arguments[c];u.fn.apply(u.context,s)}else{var f,h=u.length;for(c=0;c<h;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),l){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,n);break;case 4:u[c].fn.call(u[c].context,t,n,r);break;default:if(!s)for(f=1,s=new Array(l-1);f<l;f++)s[f-1]=arguments[f];u[c].fn.apply(u[c].context,s)}}return!0},t.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},t.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},t.prototype.removeListener=function(e,t,n,r){var o=p?p+e:e;if(!this._events[o])return this;if(!t)return u(this,o),this;var i=this._events[o];if(i.fn)i.fn!==t||r&&!i.once||n&&i.context!==n||u(this,o);else{for(var a=0,s=[],c=i.length;a<c;a++)(i[a].fn!==t||r&&!i[a].once||n&&i[a].context!==n)&&s.push(i[a]);s.length?this._events[o]=1===s.length?s[0]:s:u(this,o)}return this},t.prototype.removeAllListeners=function(e){var t;return e?(t=p?p+e:e,this._events[t]&&u(this,t)):(this._events=new n,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=p,t.EventEmitter=t,e.exports=t}),l=r(function(e,t){var h;h={VERSION:"2.4.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,PENDING:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(e,t){var n="string"==typeof e.initial?{state:e.initial}:e.initial,r=e.terminal||e.final,o=t||e.target||{},i=e.events||[],a=e.callbacks||{},s={},c={},u=function(e){var t=Array.isArray(e.from)?e.from:e.from?[e.from]:[h.WILDCARD];s[e.name]=s[e.name]||{};for(var n=0;n<t.length;n++)c[t[n]]=c[t[n]]||[],c[t[n]].push(e.name),s[e.name][t[n]]=e.to||t[n];e.to&&(c[e.to]=c[e.to]||[])};n&&(n.event=n.event||"startup",u({name:n.event,from:"none",to:n.state}));for(var l=0;l<i.length;l++)u(i[l]);for(var f in s)s.hasOwnProperty(f)&&(o[f]=h.buildEvent(f,s[f]));for(var f in a)a.hasOwnProperty(f)&&(o[f]=a[f]);return o.current="none",o.is=function(e){return Array.isArray(e)?0<=e.indexOf(this.current):this.current===e},o.can=function(e){return!this.transition&&void 0!==s[e]&&(s[e].hasOwnProperty(this.current)||s[e].hasOwnProperty(h.WILDCARD))},o.cannot=function(e){return!this.can(e)},o.transitions=function(){return(c[this.current]||[]).concat(c[h.WILDCARD]||[])},o.isFinished=function(){return this.is(r)},o.error=e.error||function(e,t,n,r,o,i,a){throw a||i},o.states=function(){return Object.keys(c).sort()},n&&!n.defer&&o[n.event](),o},doCallback:function(t,e,n,r,o,i){if(e)try{return e.apply(t,[n,r,o].concat(i))}catch(e){return t.error(n,r,o,i,h.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",e)}},beforeAnyEvent:function(e,t,n,r,o){return h.doCallback(e,e.onbeforeevent,t,n,r,o)},afterAnyEvent:function(e,t,n,r,o){return h.doCallback(e,e.onafterevent||e.onevent,t,n,r,o)},leaveAnyState:function(e,t,n,r,o){return h.doCallback(e,e.onleavestate,t,n,r,o)},enterAnyState:function(e,t,n,r,o){return h.doCallback(e,e.onenterstate||e.onstate,t,n,r,o)},changeState:function(e,t,n,r,o){return h.doCallback(e,e.onchangestate,t,n,r,o)},beforeThisEvent:function(e,t,n,r,o){return h.doCallback(e,e["onbefore"+t],t,n,r,o)},afterThisEvent:function(e,t,n,r,o){return h.doCallback(e,e["onafter"+t]||e["on"+t],t,n,r,o)},leaveThisState:function(e,t,n,r,o){return h.doCallback(e,e["onleave"+n],t,n,r,o)},enterThisState:function(e,t,n,r,o){return h.doCallback(e,e["onenter"+r]||e["on"+r],t,n,r,o)},beforeEvent:function(e,t,n,r,o){if(!1===h.beforeThisEvent(e,t,n,r,o)||!1===h.beforeAnyEvent(e,t,n,r,o))return!1},afterEvent:function(e,t,n,r,o){h.afterThisEvent(e,t,n,r,o),h.afterAnyEvent(e,t,n,r,o)},leaveState:function(e,t,n,r,o){var i=h.leaveThisState(e,t,n,r,o),a=h.leaveAnyState(e,t,n,r,o);return!1!==i&&!1!==a&&(h.ASYNC===i||h.ASYNC===a?h.ASYNC:void 0)},enterState:function(e,t,n,r,o){h.enterThisState(e,t,n,r,o),h.enterAnyState(e,t,n,r,o)},buildEvent:function(i,a){return function(){var e=this.current,t=a[e]||(a[h.WILDCARD]!=h.WILDCARD?a[h.WILDCARD]:e)||e,n=Array.prototype.slice.call(arguments);if(this.transition)return this.error(i,e,t,n,h.Error.PENDING_TRANSITION,"event "+i+" inappropriate because previous transition did not complete");if(this.cannot(i))return this.error(i,e,t,n,h.Error.INVALID_TRANSITION,"event "+i+" inappropriate in current state "+this.current);if(!1===h.beforeEvent(this,i,e,t,n))return h.Result.CANCELLED;if(e===t)return h.afterEvent(this,i,e,t,n),h.Result.NOTRANSITION;var r=this;this.transition=function(){return r.transition=null,r.current=t,h.enterState(r,i,e,t,n),h.changeState(r,i,e,t,n),h.afterEvent(r,i,e,t,n),h.Result.SUCCEEDED},this.transition.cancel=function(){r.transition=null,h.afterEvent(r,i,e,t,n)};var o=h.leaveState(this,i,e,t,n);return!1===o?(this.transition=null,h.Result.CANCELLED):h.ASYNC===o?h.Result.PENDING:this.transition?this.transition():void 0}}},e.exports&&(t=e.exports=h),t.StateMachine=h}),i=(l.StateMachine,r(function(s,e){!function(e){var u=function(){},r=Object.prototype.hasOwnProperty,l=Object.create||function(e){var t=function(){};return t.prototype=e,new t},c=Object.keys||function(e){var t=[];for(var n in e)r.call(e,n)&&t.push(n);return t},f=function(e,t){for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e},h=Object.setPrototypeOf||f,t=Object.prototype.toString,p=Array.isArray||function(e){return"[object Array]"===t.call(e)},d=function(e){return"[object Function]"===t.call(e)},v=!0,n={toString:""};for(var o in n)n.hasOwnProperty(o)&&(v=!1);var _=v?["toString","valueOf"]:null;function y(o,i,e){for(var t,n,r=function(e){var t=c(e);if(v)for(var n,r=0;n=_[r++];)e.hasOwnProperty(n)&&t.push(n);return t}(e),a=0,s=r.length;a<s;)"__self"!==(t=r[a++])&&(n=e[t],d(n)&&(!n.prototype||!n.prototype.__self)&&-1<n.toString().indexOf(".__base")?i[t]=function(e,n){var t=o[e]?o[e]:"__constructor"===e?i.__self.__parent:u,r=function(){var e=this.__base;this.__base=r.__base;var t=n.apply(this,arguments);return this.__base=e,t};return r.__base=t,r}(t,n):i[t]=n)}function m(e,t){for(var n,r=1;n=e[r++];)t?d(n)?i.self(t,n.prototype,n):i.self(t,n):t=d(n)?i(e[0],n.prototype,n):i(e[0],n);return t||e[0]}function i(){var e=arguments,t=p(e[0]),n=t||d(e[0]),r=n?t?m(e[0]):e[0]:u,o=e[n?1:0]||{},i=e[n?2:1],a=o.__constructor||n&&r.prototype&&r.prototype.__constructor?function(){return this.__constructor.apply(this,arguments)}:n?function(){return r.apply(this,arguments)}:function(){};if(!n)return a.prototype=o,a.prototype.__self=a.prototype.constructor=a,f(a,i);h(a,r);var s=(a.__parent=r).prototype,c=a.prototype=l(s);return c.__self=c.constructor=a,o&&y(s,c,o),i&&y(r,a,i),a}i.self=function(){var e=arguments,t=p(e[0])?m(e[0],e[0][0]):e[0],n=e[1],r=e[2],o=t.prototype;return n&&y(o,o,n),r&&y(t,t,r),t};var a=!0;s.exports=i,a=!1,"object"==typeof modules&&"function"==typeof modules.define&&(modules.define("inherit",function(e){e(i)}),a=!1),a&&(e.inherit=i)}(n)}));if(!t.TypedMessage)throw new Error("LeanCloud Realtime SDK not installed");var f,h=i(t.TypedMessage,{__constructor:function(e){this.__base(),this.payload=e}});h.sendOptions={transient:!0},t.messageField("payload")(h);var p,d,v,_,y=t.messageType(-102)(f=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(h))||f,m=t.messageType(-103)(p=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(h))||p,C=t.messageType(-104)(d=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(h))||d,g=t.messageType(-105)(v=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(h))||v,b=function(i){function e(e,t){var n;(n=i.call(this)||this)._setConversation(e),n._peerConnection=n._createPeerConnection(t),n._call=l.create({initial:"calling",events:[{name:"connect",from:"calling",to:"connected"},{name:"close",from:"connected",to:"closed"},{name:"cancel",from:"calling",to:"canceled"},{name:"refuse",from:"calling",to:"refused"}]}),n._promises={};var r=new Promise(function(e){n._promises.resolveStreamReady=e}),o=new Promise(function(e){n._promises.resolveAccept=e});return Promise.all([r,o]).then(function(e){var t=u(e,1)[0];n._call.can("connect")&&(n._call.connect(),n.emit("connect",t))}),n}c(e,i);var t,n,r,o=e.prototype;return o.close=function(){var e=this;return Promise.resolve().then(function(){e._call.close(),e._destroyPeerConnection(),e._peerConnection.close(),e._destroy()})},o._handleCloseEvent=function(){this._call.can("close")&&(this.close(),this.emit("close"))},o._setConversation=function(e){this._conversation&&this._conversation.off("message"),e&&(this._conversation=e).on("message",this._handleMessage.bind(this))},o._destroy=function(){this._conversation.off("message")},o._createPeerConnection=function(e){var t=new RTCPeerConnection(e);return t.onicecandidate=this._handleICECandidateEvent.bind(this),t.onaddstream=this._handleAddStreamEvent.bind(this),t.onnremovestream=this._handleRemoveStreamEvent.bind(this),t.oniceconnectionstatechange=this._handleICEConnectionStateChangeEvent.bind(this),t.onsignalingstatechange=this._handleSignalingStateChangeEvent.bind(this),t},o._destroyPeerConnection=function(){var e=this._peerConnection;delete e.onaddstream,delete e.onremovestream,delete e.onnicecandidate,delete e.oniceconnectionstatechange,delete e.onsignalingstatechange},o._handleMessage=function(e){return e instanceof y?this._handleAnswer(e):e instanceof C?this._handleRefusal():e instanceof g?this._handleCancelation():e instanceof m&&this._handleICECandidate(e)},o._handleICECandidate=function(e){var t=new RTCIceCandidate(e.payload);this._peerConnection&&this._peerConnection.addIceCandidate(t).catch(console.error.bind(console))},o._handleICECandidateEvent=function(e){return!(!e.candidate||!this._conversation)&&this._conversation.send(new m(e.candidate)).catch(console.error.bind(console))},o._handleAddStreamEvent=function(e){this._promises.resolveStreamReady(e.stream)},o._handleRemoveStreamEvent=function(){this._handleCloseEvent()},o._handleICEConnectionStateChangeEvent=function(){switch(this._peerConnection.iceConnectionState){case"closed":case"failed":case"disconnected":this._handleCloseEvent()}},o._handleSignalingStateChangeEvent=function(){switch(this._peerConnection.signalingState){case"closed":this._handleCloseEvent()}},o._handleAnswer=function(){throw new Error("not implemented")},o._handleRefusal=function(){throw new Error("not implemented")},o._handleCancelation=function(){throw new Error("not implemented")},t=e,(n=[{key:"state",get:function(){return this._call.current}}])&&a(t.prototype,n),r&&a(t,r),e}(o),w=function(o){function e(e,t,n){var r;return(r=o.call(this,t,n)||this).to=e,r}c(e,o);var t=e.prototype;return t._handleAnswer=function(e){var t=new RTCSessionDescription(e.payload);this._peerConnection.setRemoteDescription(t),this._promises.resolveAccept()},t._handleRefusal=function(){this._destroyPeerConnection(),this._call.refuse(),this.emit("refuse"),this._destroy()},t.cancel=function(){var e=this;return this._call.cancel(),this._conversation.send(new g).then(function(){return e._destroy()})},t.close=function(){return this._call.can("cancel")?this.cancel():o.prototype.close.call(this)},e}(b),E=function(i){function e(e,t,n){var r;(r=i.call(this,t,n)||this).from=e.from;var o=new RTCSessionDescription(e.payload);return r._handleOfferPromise=r._peerConnection.setRemoteDescription(o),r}c(e,i);var t=e.prototype;return t.accept=function(e){var t=this;if(!e)throw new TypeError("a MediaStream instance is required to accept a call");return this._handleOfferPromise.then(function(){return t._peerConnection.addStream(e)}).then(function(){return t._peerConnection.createAnswer()}).then(function(e){return t._peerConnection.setLocalDescription(e)}).then(function(){return t._conversation.send(new y(t._peerConnection.localDescription))}).then(function(){return t._promises.resolveAccept()})},t.refuse=function(){var e=this;return this._conversation.send(new C).then(function(){e._call.refuse(),e._destroy()})},t._handleCancelation=function(){this._call.cancel(),this.emit("cancel"),this._destroy()},e}(b),A=t.messageType(-101)(_=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(h))||_,S={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302","stun:stun.ekiga.net","stun:stun.ideasip.com","stun:stun.rixtelecom.se","stun:stun.schlund.de","stun:stun.stunprotocol.org:3478","stun:stun.voiparound.com","stun:stun.voipbuster.com","stun:stun.voipstunt.com","stun:stun.voxgratia.org"]}]},O=function(r){function e(e,t){var n;if("string"!=typeof e)throw new TypeError("id is not a string");return(n=r.call(this)||this).id=e,n.options=function(o){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?s(Object(i),!0).forEach(function(e){var t,n,r;t=o,r=i[n=e],n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):s(Object(i)).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(i,e))})}return o}({RTCConfiguration:S},t),n}c(e,r);var t=e.prototype;return t._open=function(e,t){var r=this;return e.createIMClient(this.id,t,"webrtc").then(function(e){return r._imClient=e,r.id=e.id,e.on("message",function(e,t){return e instanceof A&&r._handleOffer(e,t)}),e.on("conflict",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return r.emit.apply(r,["conflict"].concat(t))}),r})},t.close=function(){return this._imClient.close()},t.call=function(r,o){var i=this;if("string"!=typeof r)throw new TypeError("target id is not a string");if(!o)throw new TypeError("a MediaStream instance is required to make a call");return this._imClient.ping([r]).then(function(e){if(!e.length)throw new Error("Call failed as ".concat(r," is not online"));var n=new w(r,null,i.options.RTCConfiguration),t=new Promise(function(e){n._peerConnection.onnegotiationneeded=e});return n._peerConnection.addStream(o),t.then(function(){return Promise.all([i._imClient.createConversation({members:[r],unique:!0}),n._peerConnection.createOffer().then(function(e){n._peerConnection.setLocalDescription(e)})])}).then(function(e){var t=u(e,1)[0];return n._setConversation(t),t.send(new A(n._peerConnection.localDescription))}).then(function(){return n})})},t._handleOffer=function(e,t){var n=new E(e,t,this.options.RTCConfiguration);this.emit("call",n)},e}(o),T={name:"leancloud-realtime-plugin-webrtc",messageClasses:[A,y,m,C,g],onRealtimeCreate:function(n){n.createWebRTCClient=function(e,t){return new O(e)._open(n,t)}}},R=!!(window.RTCPeerConnection&&window.RTCSessionDescription&&window.RTCIceCandidate);e.WebRTCPlugin=T,e.isWebRTCSupported=R,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=webrtc.min.js.map
